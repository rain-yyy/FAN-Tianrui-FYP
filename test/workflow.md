# API 工作流文档

## 概述

Project Wiki Generation API 是一个基于 FastAPI 的异步任务处理系统，用于将项目仓库 URL 转换为 Wiki 结构和内容。本文档详细描述了整个 API 的工作流程。

## API 端点

### 1. 创建任务

-**端点**: `POST /generate`

-**功能**: 创建新的 Wiki 生成任务，立即返回任务 ID

-**请求体**: `{ "url_link": "仓库URL或本地路径" }`

-**响应**: `{ "task_id": "UUID", "message": "..." }`

### 2. 查询任务状态

-**端点**: `GET /task/{task_id}`

-**功能**: 查询指定任务的当前状态、进度和结果

-**响应**: 包含状态、进度、当前步骤、结果或错误信息

### 3. 列出所有任务

-**端点**: `GET /tasks`

-**功能**: 获取所有任务的列表（用于调试和管理）

### 4. 删除任务

-**端点**: `DELETE /task/{task_id}`

-**功能**: 删除已完成或失败的任务记录

### 5. 健康检查

-**端点**: `GET /health`

-**功能**: 检查 API 服务是否正常运行

## 任务状态

任务在整个生命周期中会经历以下状态：

-`pending`: 任务已创建，等待执行

-`processing`: 任务正在执行

-`completed`: 任务已完成

-`failed`: 任务执行失败

## 完整工作流程

### 阶段 1: 任务创建 (0%)

**入口**: `POST /generate`

1. 接收用户请求，包含仓库 URL 或本地路径
2. 生成唯一任务 ID (UUID)
3. 创建任务记录，初始状态为 `pending`
4. 启动后台异步任务 `execute_generation_task`
5. 立即返回任务 ID，不等待任务完成

---

### 阶段 2: 仓库准备 (5-15%)

**函数**: `run_structure_generation` → `setup_repository`

1.**克隆/读取仓库** (5%)

- 如果 URL 是 Git 地址（http/https/git@），则克隆仓库到临时目录
- 如果是本地路径，直接使用该路径
- 更新进度: "正在克隆/读取仓库..."

2.**加载配置** (15%)

- 加载 `config/repo_config.json` 配置文件
- 验证配置文件有效性
- 更新进度: "仓库准备完成，正在加载配置..."

---

### 阶段 3: 文件树生成 (20%)

**函数**: `generate_file_tree`

1.**文件过滤**

- 根据配置文件中的 `file_filters` 过滤文件
- 排除指定的目录和文件模式
- 过滤二进制文件
- 只保留文本文件

2.**文件分类**

- 将文件分为代码文件（code）和文本文件（text）
- 根据文件扩展名和特殊文件名判断

3.**生成目录树**

- 构建文件目录树结构
- 转换为文本格式的树形结构
- 更新进度: "正在生成文件树..."

---

### 阶段 4: Wiki 结构生成 (30-40%)

**函数**: `generate_wiki_structure`

#### 4.1 构建 RepoMap 上下文 (25-30%)

**函数**: `_build_repo_map_context`

1. 调用 RepoMapper 工具
2. 查找源代码文件（默认在 `src` 目录）
3. 生成代码骨架摘要
4. 用于后续 LLM 提示词构建

#### 4.2 构建代码知识图谱与社区分析 (30-35%)

**函数**: `CodeGraphBuilder` + `CommunityEngine`

1.**构建代码知识图谱** (30%)

- 使用 Tree-sitter 解析代码文件
- 提取函数、类、变量等代码实体
- 构建代码实体之间的调用关系图
- 更新进度: "正在构建代码知识图谱与社区分析..."

2.**社区发现** (35%)

- 运行 Leiden 社区发现算法
- 将代码实体分组到不同的社区
- 每个社区代表一个功能模块或业务领域

3.**生成社区摘要** (35%)

- 为每个社区生成摘要描述
- 使用 DeepSeek 客户端生成社区功能说明
- 更新进度: "正在生成 Wiki 目录结构（包含 GraphRAG 社区分析）..."

#### 4.3 生成 Wiki 目录结构 (35-40%)

1.**准备提示词上下文**

- 文件树结构
- README.md 内容（如果存在）
- RepoMap 代码骨架摘要
- 社区信息（GraphRAG 结果）

2.**调用 LLM**

- 使用 Qwen Plus 模型
- 温度参数: 0.1（确保输出稳定）
- 生成分层的 Wiki 目录结构 JSON

3.**解析和验证**

- 解析 LLM 返回的 JSON
- 验证结构完整性（title, description, toc）
- 规范化 TOC 节点结构
- 保存到 `wiki_structure.json`
- 更新进度: "Wiki 目录结构生成完成" (40%)

---

### 阶段 5: Wiki 内容生成 (45-85%)

**函数**: `WikiContentGenerator.generate`

#### 5.1 初始化 (45%)

1. 初始化 AI 客户端（Qwen）
2. 创建输出目录 `wiki_section_json`
3. 更新进度: "正在初始化 AI 客户端..."

#### 5.2 遍历章节生成内容 (50-85%)

**函数**: `_generate_section`

对 Wiki 结构中的每个章节（section）执行：

1.**收集文件上下文** (50-80%)

- 读取章节关联的文件内容
- 限制每个文件最多 4000 字符
- 限制每个章节总上下文最多 16000 字符
- 从代码知识图谱中提取依赖关系信息
- 更新进度: "正在生成 Wiki 内容（此步骤可能耗时较长）..."

2.**构建提示词**

- 文档标题和描述
- 章节面包屑路径
- 章节 ID
- 文件上下文内容

3.**调用 LLM 生成内容**

- 使用 Qwen 客户端
- 最大 token 数: 1800
- 生成包含以下内容的 JSON：

-`intro`: 章节简介

-`sections`: 子章节列表

-`mermaid`: Mermaid 架构图代码

4.**保存结果**

- 将结果写入 JSON 文件
- 文件名格式: `{section_id}.json`
- 包含章节元数据、文件列表和生成的内容

5.**进度更新**

- 根据章节数量动态更新进度
- 最终进度: 85%

---

### 阶段 6: 上传到 R2 存储 (90%)

**函数**: `upload_wiki_to_r2`

1.**初始化 R2 客户端**

- 检查 R2 配置（Access Key, Secret Key, Endpoint, Bucket）
- 如果配置缺失，跳过上传，返回本地路径

2.**生成存储路径**

- 从仓库 URL 提取仓库名称
- 生成日期路径
- 基础路径格式: `{repo_name}/{date}`

3.**上传 Wiki 结构**

- 上传 `wiki_structure.json`
- R2 Key: `{base_path}/wiki_structure.json`
- 获取公共访问 URL

4.**上传内容文件**

- 上传 `wiki_section_json` 目录下的所有 JSON 文件
- R2 Key 前缀: `{base_path}/sections/`
- 收集所有成功上传的文件 URL

5.**更新进度**: "正在上传到 R2 存储..." (90%)

---

### 阶段 7: 任务完成 (100%)

1.**更新任务状态**

- 状态: `completed`
- 进度: 100%
- 当前步骤: "任务完成"
- 保存结果：

-`r2_structure_url`: Wiki 结构的 R2 URL

-`r2_content_urls`: 所有内容文件的 R2 URL 列表

2.**清理本地文件** (后台静默执行)

- 删除克隆的仓库目录
- 删除 `wiki_structure.json`
- 删除 `wiki_section_json` 目录
- 释放存储空间

---

## 错误处理

### 任务失败场景

1.**仓库克隆失败**

- 网络连接超时
- 仓库不存在或无权访问
- 错误信息保存到 `task.error`

2.**配置文件缺失**

-`config/repo_config.json` 不存在

- 抛出 `FileNotFoundError`

3.**LLM 调用失败**

- API 密钥无效
- 网络错误
- 模型响应格式错误

4.**R2 上传失败**

- 配置缺失（会跳过上传，返回本地路径）
- 网络错误
- 权限问题

### 错误响应格式

```json

{

"task_id": "...",

"status": "failed",

"progress": 30.0,

"current_step": "任务失败",

"error": "错误描述信息",

"result": null

}

```

---

## 数据流图

```

用户请求 (POST /generate)

    ↓

创建任务记录 (pending)

    ↓

启动后台任务 (execute_generation_task)

    ↓

┌─────────────────────────────────────┐

│ 1. 仓库准备 (5-15%)                 │

│    - 克隆/读取仓库                   │

│    - 加载配置                       │

└─────────────────────────────────────┘

    ↓

┌─────────────────────────────────────┐

│ 2. 文件树生成 (20%)                 │

│    - 过滤文件                       │

│    - 生成目录树                     │

└─────────────────────────────────────┘

    ↓

┌─────────────────────────────────────┐

│ 3. Wiki 结构生成 (30-40%)           │

│    - 构建 RepoMap                   │

│    - 构建代码知识图谱               │

│    - 社区发现 (Leiden)              │

│    - 生成社区摘要                   │

│    - LLM 生成目录结构               │

└─────────────────────────────────────┘

    ↓

┌─────────────────────────────────────┐

│ 4. Wiki 内容生成 (45-85%)           │

│    - 遍历每个章节                   │

│    - 收集文件上下文                 │

│    - LLM 生成内容和 Mermaid 图     │

│    - 保存 JSON 文件                 │

└─────────────────────────────────────┘

    ↓

┌─────────────────────────────────────┐

│ 5. 上传到 R2 (90%)                  │

│    - 上传 wiki_structure.json       │

│    - 上传 sections/*.json           │

└─────────────────────────────────────┘

    ↓

┌─────────────────────────────────────┐

│ 6. 任务完成 (100%)                   │

│    - 更新状态为 completed            │

│    - 保存结果 URL                   │

│    - 清理本地文件                   │

└─────────────────────────────────────┘

    ↓

用户查询 (GET /task/{task_id})

    ↓

返回结果

```

---

## 关键技术组件

### 1. 代码知识图谱 (Code Knowledge Graph)

-**工具**: Tree-sitter

-**功能**: 解析代码，提取实体和关系

-**输出**: 有向图结构，节点为代码实体，边为调用关系

### 2. 社区发现 (Community Detection)

-**算法**: Leiden 算法

-**功能**: 将代码实体分组到功能社区

-**输出**: 社区 ID 到节点列表的映射

### 3. 社区摘要生成

-**模型**: DeepSeek

-**功能**: 为每个社区生成功能描述摘要

-**用途**: 增强 Wiki 结构生成的上下文

### 4. RepoMap

-**工具**: RepoMapper

-**功能**: 生成代码骨架摘要

-**用途**: 为 LLM 提供项目整体结构概览

### 5. 混合检索 (Hybrid Retrieval)

-**密集检索**: FAISS 向量库

-**稀疏检索**: BM25 索引

-**用途**: 在 RAG 问答中检索相关文档

---

## 进度追踪

任务进度通过以下方式实时更新：

-**进度百分比**: 0-100

-**当前步骤描述**: 中文描述当前执行的操作

-**更新时间**: 每次进度更新时记录时间戳

客户端可以通过轮询 `GET /task/{task_id}` 接口获取最新进度。

---

## 性能优化

1.**异步任务处理**

- 使用 FastAPI 的异步特性
- 长时间运行的任务在线程池中执行
- 不阻塞 API 响应

2.**文件清理**

- 任务完成后自动清理临时文件
- 释放存储空间

3.**上下文限制**

- 文件内容截断（4000 字符/文件）
- 章节上下文限制（16000 字符/章节）
- 避免超出 LLM 上下文窗口

---

## 注意事项

1.**任务存储**: 当前使用内存存储，服务重启后任务记录会丢失

2.**并发限制**: 大量并发任务可能消耗大量系统资源

3.**文件清理**: 失败的任务可能保留部分文件，需要手动清理

4.**R2 配置**: 如果 R2 配置缺失，系统会跳过上传，返回本地路径

5.**LLM 依赖**: 需要配置有效的 AI 客户端（OpenAI/Qwen/DeepSeek）

---

## 相关文件

-**API 入口**: `docker/scripts/api.py`

-**结构生成**: `docker/src/wiki/struct_gen.py`

-**内容生成**: `docker/src/wiki/content_gen.py`

-**文件处理**: `docker/src/ingestion/file_processor.py`

-**代码图谱**: `docker/src/ingestion/code_graph.py`

-**社区引擎**: `docker/src/ingestion/community_engine.py`

-**R2 存储**: `docker/src/storage/r2_client.py`

-**RAG 聊天**: `docker/src/core/chat.py`

-**检索模块**: `docker/src/core/retrieval.py`

# Project Wiki Generation API 技术文档与路线图

## 1. 项目概述

本项目是一个自动化的 Wiki 生成系统，旨在将复杂的 Git 仓库（如 GitHub 上的项目）自动分析并转化为结构化的 Wiki 文档。系统通过静态代码分析、文件树提取以及大语言模型（LLM）的理解能力，自动生成项目的功能描述、架构图（Mermaid）以及各模块的详细解释。

## 2. API 路线图 (Roadmap)

整个 Wiki 生成流程遵循**“异步任务处理 + 云端持久化”**的设计模式，确保能够处理耗时较长的 AI 生成任务。

### 核心工作流：

1. **任务触发**: 用户提交仓库 URL。
2. **环境准备**: 后端异步克隆仓库并加载配置文件。
3. **静态分析**:
   * 生成完整的文件树（File Tree）。
   * 基于文件树生成 Wiki 的层级结构（Wiki Structure）。
4. **AI 内容生成**:
   * 并发调用 AI 客户端（如通义千问 Qwen）。
   * 为每个 Wiki 节点生成详细的内容描述和业务逻辑。
   * 生成 Mermaid 流程图或架构图。
5. **结果持久化**:
   * 将生成的 `wiki_structure.json` 上传至 Cloudflare R2。
   * 将各章节的详细内容 JSON 文件同步至 R2 存储。
6. **清理与反馈**:
   * 清理本地克隆的仓库和临时文件。
   * 更新任务状态为“已完成”，提供 R2 公网访问 URL。

---

## 3. API 端点详解

### 3.1 任务管理

* **POST `/generate`**:
  * **功能**: 创建 Wiki 生成任务。
  * **输入**: `{ "url_link": "仓库地址" }`
  * **逻辑**: 生成唯一 UUID，初始化任务状态并推入后台异步执行。
  * **返回**: 任务 ID (`task_id`)。
* **GET `/task/{task_id}`**:
  * **功能**: 查询指定任务的状态和进度。
  * **返回**: 包含状态（pending/processing/completed/failed）、进度（0-100%）、当前步骤以及最终结果。
* **GET `/tasks`**:
  * **功能**: 列出内存中存储的所有任务记录（调试用）。
* **DELETE `/task/{task_id}`**:
  * **功能**: 删除已完成或失败的任务记录，释放内存空间。

### 3.2 系统状态

* **GET `/health`**:
  * **功能**: 健康检查，确认服务运行正常。

---

## 4. 技术实现细节

### 4.1 异步任务架构

* **FastAPI + Asyncio**: 利用 FastAPI 的异步特性，结合 `asyncio.create_task` 实现任务的即时返回与后台执行。
* **Thread Pool Executor**: 针对同步的 Git 操作（克隆）和文件 I/O 操作，使用 `loop.run_in_executor` 运行在线程池中，避免阻塞主事件循环。

### 4.2 AI 客户端集成 (AI Client Factory)

* 系统实现了 `AIClientFactory` 模式，支持动态切换不同的模型供应商：
  * **Qwen (默认)**: 用于生成 Wiki 内容，具备较强的中文理解和代码分析能力。
  * **OpenAI**: 作为备选方案。
  * **DeepSeek**: 用于高性能、低成本的推理。

### 4.3 存储方案 (Cloudflare R2)

* 系统使用 **Boto3 SDK** 对接 Cloudflare R2。
* **路径设计**: `{repo_name}/{YYYYMMDD}/...` 确保了不同版本和不同项目的存储隔离。
* **自动清理**: 任务完成后，系统会自动执行 `shutil.rmtree` 和 `unlink` 清理容器内的临时文件，保证轻量化运行。

### 4.4 容器化部署

* **Dockerfile**: 基于 `python:3.11-slim`，预装了 `git` 环境。
* **Environment**: 通过环境变量配置 R2 凭证、AI API Keys 以及服务端口。

---

## 5. 未来优化方案 (Roadmap)

根据 RAG（检索增强生成）优化路线，未来 API 将引入以下改进：

1. **混合检索**: 引入 BM25 + 向量检索，提升对代码符号和特定术语的召回准确率。
2. **重排机制 (Reranker)**: 在生成 Wiki 内容前，对检索到的上下文进行 Cross-Encoder 重排。
3. **领域感知切分**: 针对不同文件类型（如 `.py` 采用 AST 切分，`.md` 采用标题感知切分）优化生成质量。
4. **持久化任务队列**: 将目前的内存 `tasks_store` 迁移至 Redis，支持服务重启后的任务恢复。
5. **并发限制**: 引入信号量或 Celery 队列，防止大量并发任务导致 AI Token 熔断或磁盘占满。
